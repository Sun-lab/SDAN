---
title: "Prepare scRNA-seq data from Yost et al. 2019"
author: "Wei Sun"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: journal
    highlight: tango
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
    number_sections: false
  df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 80)
```

Prepare the scRNA-seq data from Yost et al.

> Yost, K.E., Satpathy, A.T., Wells, D.K. et al. Clonal replacement of tumor-specific T cells following PD-1 blockade. Nat Med 25, 1251â€“1259 (2019). 


All patients had histologically proven advanced or metastatic BCC or SCC and were not suitable candidates for surgical resection
 
# Setup

## Load R libraries
```{r load_libraries, warning = FALSE, message = FALSE}
library(data.table)
library(readxl)
library(dplyr)

data_dir = "../../cancer_TCR/data/Yost_2019/GSE"
```

# Check data

The data files were downloaded from GEO: GSE123813

https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE123813

```
GSE123813_bcc_scRNA_counts.txt.gz	100.3 Mb
GSE123813_bcc_tcell_metadata.txt.gz	824.5 Kb
GSE123813_scc_metadata.txt.gz	639.3 Kb
GSE123813_scc_scRNA_counts.txt.gz	45.3 Mb
```

Since some of the data files are large, and they have been saved in ```cancer_TCR``` repo, I do not save extra copies in this repo. 

Patient information can be obtained from Supplementary Table 1 of Yost et al.

## Read in count data
```{r}
patient_info = read_xlsx("data/41591_2019_522_MOESM2_ESM.xlsx", 
                         sheet = "SuppTable1", 
                         range = "A4:U19", 
                         col_names = TRUE) %>% as.data.frame()
dim(patient_info)
patient_info[1:2,]

table(patient_info$`Tumor Type`)
patient_info$`Patient`
patient_info[grep("su010", patient_info$Patient),]

table(patient_info$Response)
table(patient_info$`Treatment`)
table(patient_info$`Prior treatment`)
```


## Read in count data

```{r}
bcc_cts = fread(file.path(data_dir, 
                          "GSE123813_bcc_scRNA_counts.txt.gz"))
dim(bcc_cts)
bcc_cts[1:2,1:4]
names(bcc_cts)[1] = "gene"

scc_cts = fread(file.path(data_dir, 
                          "GSE123813_scc_scRNA_counts.txt.gz"))
dim(scc_cts)
scc_cts[1:2,1:4]
names(scc_cts)[1] = "gene"
```

## Read in meta data

```{r}
bcc_tcell_meta = fread(file.path(data_dir, 
                                 "GSE123813_bcc_tcell_metadata.txt.gz"))
dim(bcc_tcell_meta)
bcc_tcell_meta[1:2,]

table(bcc_tcell_meta$patient, bcc_tcell_meta$treatment)

scc_meta = fread(file.path(data_dir, 
                           "GSE123813_scc_metadata.txt.gz"))
dim(scc_meta)
scc_meta[1:2,]

table(scc_meta$patient, scc_meta$treatment)
scc_meta$patient[scc_meta$patient == "su010"] = "su010-S"
table(scc_meta$patient, scc_meta$treatment)

stopifnot(all(bcc_tcell_meta$cell.id %in% names(bcc_cts)))
stopifnot(setequal(scc_meta$cell.id, names(scc_cts)[-1]))
```


## Extract CD8+ T cells

```{r}
table(bcc_tcell_meta$cluster)

bcc_cd8_meta = bcc_tcell_meta[grep("CD8_", cluster),]
dim(bcc_cd8_meta)
table(bcc_cd8_meta$cluster)

mat1 = c(1, match(bcc_cd8_meta$cell.id, names(bcc_cts)))
bcc_cd8_cts = bcc_cts[,..mat1]

dim(bcc_cd8_cts)
bcc_cd8_cts[1:2,1:4]

table(scc_meta$cluster)

scc_cd8_meta = scc_meta[grep("CD8_", cluster),]
dim(scc_cd8_meta)
table(scc_cd8_meta$cluster)

mat1 = c(1, match(scc_cd8_meta$cell.id, names(scc_cts)))
scc_cd8_cts = scc_cts[,..mat1]

dim(scc_cd8_cts)
scc_cd8_cts[1:2,1:4]
```

## Select genes to use

Those genes that only belong to BCC or SCC have large proportion of 0's. So we only keep the genes that appear in both groups. 

```{r}
length(unique(bcc_cd8_cts$gene))
length(unique(scc_cd8_cts$gene))

table(scc_cd8_cts$gene %in% bcc_cd8_cts$gene)
scc_only_gene = setdiff(scc_cd8_cts$gene, bcc_cd8_cts$gene)
bcc_only_gene = setdiff(bcc_cd8_cts$gene, scc_cd8_cts$gene)

length(scc_only_gene)
length(bcc_only_gene)

prop_0_scc = rowMeans(scc_cd8_cts[,-1] > 0)
prop_0_bcc = rowMeans(bcc_cd8_cts[,-1] > 0)

summary(prop_0_scc[scc_cd8_cts$gene %in% scc_only_gene])
summary(prop_0_scc[!scc_cd8_cts$gene %in% scc_only_gene])

summary(prop_0_bcc[bcc_cd8_cts$gene %in% bcc_only_gene])
summary(prop_0_bcc[!bcc_cd8_cts$gene %in% bcc_only_gene])

gene2kp = intersect(scc_cd8_cts$gene, bcc_cd8_cts$gene)
length(gene2kp)

bcc_cd8_cts = bcc_cd8_cts[match(gene2kp, bcc_cd8_cts$gene),]
scc_cd8_cts = scc_cd8_cts[match(gene2kp, scc_cd8_cts$gene),]

dim(bcc_cd8_cts)
bcc_cd8_cts[1:2,1:4]

dim(scc_cd8_cts)
scc_cd8_cts[1:2,1:4]

length(intersect(names(bcc_cd8_cts), 
                 names(scc_cd8_cts)))

yost_cd8_cts = merge(bcc_cd8_cts, scc_cd8_cts, by="gene")

bcc_cd8_meta = bcc_tcell_meta[match(names(bcc_cd8_cts)[-1], 
                                    bcc_tcell_meta$cell.id),]

scc_cd8_meta = scc_meta[match(names(scc_cd8_cts)[-1], 
                                    scc_meta$cell.id),]

yost_cd8_meta = rbind(bcc_cd8_meta, scc_cd8_meta)

stopifnot(all(names(yost_cd8_cts)[-1] == yost_cd8_meta$cell.id))

dim(yost_cd8_cts)
yost_cd8_cts[1:2,1:4]

dim(yost_cd8_meta)
yost_cd8_meta[1:4,]
```


## Save the count data of T cells as a text file

Save text file and then gz tend to give a smaller file than saving a sparse matrix.

```{r}
fnm = "data/yost_cd8_counts.tsv"
if(! file.exists(paste0(fnm, ".gz"))){
  fwrite(yost_cd8_cts, fnm, sep="\t")
  system(sprintf("gzip -f %s", fnm))
}

fnm = "data/yost_cd8_meta.tsv"
fwrite(yost_cd8_meta, fnm, sep="\t")

```



# Session information
```{r}
gc()

sessionInfo()
```



